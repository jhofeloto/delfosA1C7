{% extends "base.html" %}

{% block title %}Predicciones - Delfos A1 C7{% endblock %}

{% block extra_head %}
<style>
    .prediction-form {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 15px;
        padding: 30px;
    }
    
    .results-section {
        display: none;
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .glucose-level {
        font-size: 2.5rem;
        font-weight: bold;
    }
    
    .diabetes-class {
        font-size: 1.8rem;
        font-weight: bold;
    }
    
    .probability-bar {
        height: 25px;
        border-radius: 12px;
        transition: width 0.8s ease;
    }
    
    .loading-spinner {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12 text-center mb-5">
            <h1 class="fw-bold">
                <i class="fas fa-calculator text-primary"></i>
                Sistema de Predicción
            </h1>
            <p class="lead text-muted">
                Ingrese los datos clínicos para obtener predicciones de glucosa y clasificación de diabetes
            </p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Formulario de Predicción -->
            <div class="prediction-form">
                <form id="predictionForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edad" class="form-label">
                                <i class="fas fa-birthday-cake"></i> Edad (años)
                            </label>
                            <input type="number" class="form-control" id="edad" name="edad" 
                                   min="0" max="120" step="1" required>
                            <div class="form-text">Edad del paciente en años</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="imc" class="form-label">
                                <i class="fas fa-weight"></i> IMC (kg/m²)
                            </label>
                            <input type="number" class="form-control" id="imc" name="imc" 
                                   min="10" max="60" step="0.1" required>
                            <div class="form-text">Índice de Masa Corporal</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="presion_sistolica" class="form-label">
                                <i class="fas fa-heartbeat"></i> Presión Sistólica (mmHg)
                            </label>
                            <input type="number" class="form-control" id="presion_sistolica" name="presion_sistolica" 
                                   min="80" max="250" step="1" required>
                            <div class="form-text">Presión arterial sistólica</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="presion_diastolica" class="form-label">
                                <i class="fas fa-heartbeat"></i> Presión Diastólica (mmHg)
                            </label>
                            <input type="number" class="form-control" id="presion_diastolica" name="presion_diastolica" 
                                   min="50" max="150" step="1" required>
                            <div class="form-text">Presión arterial diastólica</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="perimetro_abdominal" class="form-label">
                                <i class="fas fa-ruler"></i> Perímetro Abdominal (cm)
                            </label>
                            <input type="number" class="form-control" id="perimetro_abdominal" name="perimetro_abdominal" 
                                   min="50" max="200" step="0.1" required>
                            <div class="form-text">Circunferencia de la cintura</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="ejercicio" class="form-label">
                                <i class="fas fa-running"></i> Ejercicio (horas/semana)
                            </label>
                            <input type="number" class="form-control" id="ejercicio" name="ejercicio" 
                                   min="0" max="50" step="0.5" required>
                            <div class="form-text">Horas de ejercicio por semana</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="consumo_frutas" class="form-label">
                                <i class="fas fa-apple-alt"></i> Consumo de Frutas (porciones/día)
                            </label>
                            <input type="number" class="form-control" id="consumo_frutas" name="consumo_frutas" 
                                   min="0" max="20" step="0.5" required>
                            <div class="form-text">Porciones de fruta diarias</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="cigarrillos" class="form-label">
                                <i class="fas fa-smoking-ban"></i> Cigarrillos (por día)
                            </label>
                            <input type="number" class="form-control" id="cigarrillos" name="cigarrillos" 
                                   min="0" max="100" step="1" required>
                            <div class="form-text">Número de cigarrillos por día</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="diabetes_familiar" class="form-label">
                                <i class="fas fa-users"></i> Diabetes Familiar
                            </label>
                            <select class="form-select" id="diabetes_familiar" name="diabetes_familiar" required>
                                <option value="">Seleccione...</option>
                                <option value="0">No</option>
                                <option value="1">Sí</option>
                            </select>
                            <div class="form-text">Antecedentes familiares de diabetes</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="puntaje_riesgo" class="form-label">
                                <i class="fas fa-exclamation-triangle"></i> Puntaje de Riesgo
                            </label>
                            <input type="number" class="form-control" id="puntaje_riesgo" name="puntaje_riesgo" 
                                   min="0" max="100" step="0.1" required>
                            <div class="form-text">Puntaje de riesgo cardiovascular</div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-magic"></i> Realizar Predicción
                        </button>
                        
                        <div class="loading-spinner mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Procesando...</span>
                            </div>
                            <p class="mt-2">Procesando predicción...</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sección de Resultados -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="results-section" id="resultsSection">
                <h2 class="text-center mb-4">
                    <i class="fas fa-chart-line text-success"></i>
                    Resultados de la Predicción
                </h2>
                
                <div class="row">
                    <!-- Nivel de Glucosa -->
                    {% if regression_available %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="fas fa-tint text-danger"></i>
                                    Nivel de Glucosa Predicho
                                </h5>
                                <div class="glucose-level text-primary" id="glucoseLevel">
                                    -- mg/dL
                                </div>
                                <div class="mt-3">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" id="glucoseBar" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted">Rango normal: 70-100 mg/dL</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Clasificación de Diabetes -->
                    {% if classification_available %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="fas fa-tags text-warning"></i>
                                    Clasificación de Diabetes
                                </h5>
                                <div class="diabetes-class" id="diabetesClass">
                                    --
                                </div>
                                <div class="mt-3" id="probabilitiesSection">
                                    <!-- Las probabilidades se cargarán dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Interpretación -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-lightbulb text-info"></i>
                                    Interpretación de Resultados
                                </h5>
                                <div id="interpretation">
                                    <!-- La interpretación se cargará dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not regression_available and not classification_available %}
<div class="container py-5">
    <div class="alert alert-warning text-center">
        <h4><i class="fas fa-exclamation-triangle"></i> Modelos No Disponibles</h4>
        <p>Los modelos de predicción no están disponibles actualmente. 
           Por favor, verifique que los archivos de modelos estén presentes en el directorio 'models/'.</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('predictionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Mostrar spinner de carga
    document.querySelector('.loading-spinner').style.display = 'block';
    
    // Recopilar datos del formulario
    const formData = new FormData(this);
    const data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = parseFloat(value);
    }
    
    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result.predictions);
        } else {
            alert('Error en la predicción: ' + result.error);
        }
    } catch (error) {
        alert('Error de conexión: ' + error.message);
    } finally {
        // Ocultar spinner
        document.querySelector('.loading-spinner').style.display = 'none';
    }
});

function displayResults(predictions) {
    const resultsSection = document.getElementById('resultsSection');
    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // Mostrar nivel de glucosa
    if (predictions.glucose_level) {
        document.getElementById('glucoseLevel').textContent = predictions.glucose_level + ' mg/dL';
        
        // Actualizar barra de progreso de glucosa
        const glucoseBar = document.getElementById('glucoseBar');
        const glucoseValue = predictions.glucose_level;
        let percentage = Math.min((glucoseValue / 200) * 100, 100);
        let barClass = 'bg-success';
        
        if (glucoseValue >= 126) {
            barClass = 'bg-danger';
        } else if (glucoseValue >= 100) {
            barClass = 'bg-warning';
        }
        
        glucoseBar.className = 'progress-bar ' + barClass;
        glucoseBar.style.width = percentage + '%';
    }
    
    // Mostrar clasificación de diabetes
    if (predictions.diabetes_class) {
        const diabetesClass = document.getElementById('diabetesClass');
        diabetesClass.textContent = predictions.diabetes_class;
        
        // Establecer color según la clase
        diabetesClass.className = 'diabetes-class';
        if (predictions.diabetes_class === 'Normal') {
            diabetesClass.classList.add('text-success');
        } else if (predictions.diabetes_class === 'Prediabetes') {
            diabetesClass.classList.add('text-warning');
        } else {
            diabetesClass.classList.add('text-danger');
        }
        
        // Mostrar probabilidades
        if (predictions.class_probabilities) {
            const probSection = document.getElementById('probabilitiesSection');
            let probHtml = '';
            
            for (const [className, probability] of Object.entries(predictions.class_probabilities)) {
                let barColor = 'bg-secondary';
                if (className === 'Normal') barColor = 'bg-success';
                else if (className === 'Prediabetes') barColor = 'bg-warning';
                else if (className === 'Diabetes') barColor = 'bg-danger';
                
                probHtml += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <small>${className}</small>
                            <small>${probability}%</small>
                        </div>
                        <div class="probability-bar ${barColor}" style="width: ${probability}%"></div>
                    </div>
                `;
            }
            
            probSection.innerHTML = probHtml;
        }
    }
    
    // Generar interpretación
    generateInterpretation(predictions);
}

function generateInterpretation(predictions) {
    const interpretation = document.getElementById('interpretation');
    let html = '<div class="row">';
    
    if (predictions.glucose_level) {
        const glucose = predictions.glucose_level;
        let glucoseInterpretation = '';
        let alertClass = 'alert-success';
        
        if (glucose < 70) {
            glucoseInterpretation = 'Nivel de glucosa por debajo del rango normal (hipoglucemia). Se recomienda consulta médica inmediata.';
            alertClass = 'alert-danger';
        } else if (glucose <= 100) {
            glucoseInterpretation = 'Nivel de glucosa en rango normal. Mantener hábitos saludables.';
            alertClass = 'alert-success';
        } else if (glucose <= 125) {
            glucoseInterpretation = 'Nivel de glucosa en rango de prediabetes. Se recomienda cambios en el estilo de vida y seguimiento médico.';
            alertClass = 'alert-warning';
        } else {
            glucoseInterpretation = 'Nivel de glucosa indicativo de diabetes. Se recomienda consulta médica para confirmación diagnóstica.';
            alertClass = 'alert-danger';
        }
        
        html += `
            <div class="col-md-6">
                <div class="alert ${alertClass}">
                    <h6><i class="fas fa-tint"></i> Glucosa</h6>
                    <p class="mb-0">${glucoseInterpretation}</p>
                </div>
            </div>
        `;
    }
    
    if (predictions.diabetes_class) {
        let classInterpretation = '';
        let alertClass = 'alert-success';
        
        if (predictions.diabetes_class === 'Normal') {
            classInterpretation = 'La clasificación indica ausencia de diabetes. Continuar con controles preventivos regulares.';
            alertClass = 'alert-success';
        } else if (predictions.diabetes_class === 'Prediabetes') {
            classInterpretation = 'La clasificación indica prediabetes. Es crucial implementar cambios en el estilo de vida para prevenir la progresión a diabetes.';
            alertClass = 'alert-warning';
        } else {
            classInterpretation = 'La clasificación indica diabetes. Se requiere manejo médico especializado y monitoreo continuo.';
            alertClass = 'alert-danger';
        }
        
        html += `
            <div class="col-md-6">
                <div class="alert ${alertClass}">
                    <h6><i class="fas fa-tags"></i> Clasificación</h6>
                    <p class="mb-0">${classInterpretation}</p>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    html += `
        <div class="mt-3">
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle"></i> Nota Importante</h6>
                <p class="mb-0">
                    <strong>Estas predicciones son herramientas de apoyo y no reemplazan el criterio médico profesional.</strong>
                    Siempre consulte con un médico para diagnósticos definitivos y planes de tratamiento.
                </p>
            </div>
        </div>
    `;
    
    interpretation.innerHTML = html;
}
</script>
{% endblock %}